#!/usr/bin/env bash
set -e

if [ ! -d "$MOODLE_DOCKER_WWWROOT" ];
then
    echo 'Error: MOODLE_DOCKER_WWWROOT is not set or not an existing directory'
    exit 1
fi

if [ -z "$MOODLE_DOCKER_DB" ];
then
    echo 'Error: MOODLE_DOCKER_DB is not set'
    exit 1
fi

# Nasty portable way to the directory of this script, following symlink,
# because readlink -f not on OSX. Thanks stack overflow..
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
basedir="$( cd -P "$( dirname "$SOURCE" )/../" && pwd )"
export ASSETDIR="${basedir}/assets"


dockercompose_cmd=("docker-compose" "-f" "${basedir}/base.yml")
dockercompose_cmd+=("-f" "${basedir}/service.mail.yml")

# PHP Version.
export MOODLE_DOCKER_PHP_VERSION=${MOODLE_DOCKER_PHP_VERSION:-7.3}

# Database flavour
if [ "$MOODLE_DOCKER_DB" != 'pgsql' ];
then
    dockercompose_cmd+=("-f" "${basedir}/db.${MOODLE_DOCKER_DB}.yml")
fi

# Support PHP version overrides for DB..
filename="${basedir}/db.${MOODLE_DOCKER_DB}.${MOODLE_DOCKER_PHP_VERSION}.yml"
if [ -f "$filename" ]; then
    dockercompose_cmd+=("-f" "${filename}")
fi

# Mobile app deprecated variables
if [ -n "$MOODLE_APP_VERSION" ];
then
    echo 'Warning: MOODLE_APP_VERSION is deprecated, use MOODLE_DOCKER_APP_VERSION instead'

    if [ -z "$MOODLE_DOCKER_APP_VERSION" ];
    then
        export MOODLE_DOCKER_APP_VERSION="$MOODLE_APP_VERSION"
    fi
fi

# Mobile app for development
if [[ -n "$MOODLE_DOCKER_BROWSER" && "$MOODLE_DOCKER_BROWSER" == "chrome" \
          && -n "$MOODLE_DOCKER_APP_PATH" ]];
then
    dockercompose_cmd+=("-f" "${basedir}/moodle-app-dev.yml")
# Mobile app using a docker image
elif [[ -n "$MOODLE_DOCKER_BROWSER" && "$MOODLE_DOCKER_BROWSER" == "chrome" \
            && -n "$MOODLE_DOCKER_APP_VERSION" ]];
then
    dockercompose_cmd+=("-f" "${basedir}/moodle-app.yml")
fi

# Selenium browser
if [[ -n "$MOODLE_DOCKER_BROWSER" && "$MOODLE_DOCKER_BROWSER" != "firefox" ]];
then
    dockercompose_cmd+=("-f" "${basedir}/selenium.${MOODLE_DOCKER_BROWSER}.yml")
fi

# Selenium VNC port
export MOODLE_DOCKER_SELENIUM_SUFFIX=""
if [[ $MOODLE_DOCKER_SELENIUM_VNC_PORT == *":"* || $MOODLE_DOCKER_SELENIUM_VNC_PORT -gt 0 ]]
then
    export MOODLE_DOCKER_SELENIUM_SUFFIX="-debug"
    # If no bind ip has been configured (bind_ip:port), default to 127.0.0.1
    if [[ ! $MOODLE_DOCKER_SELENIUM_VNC_PORT == *":"* ]]
    then
        MOODLE_DOCKER_SELENIUM_VNC_PORT=127.0.0.1:$MOODLE_DOCKER_SELENIUM_VNC_PORT
    fi
    dockercompose_cmd+=("-f" "${basedir}/selenium.debug.yml")
fi

# External services
if [[ -n "$MOODLE_DOCKER_PHPUNIT_EXTERNAL_SERVICES" ]];
then
    dockercompose_cmd+=("-f" "${basedir}/phpunit-external-services.yml")
fi

# Webserver host
export MOODLE_DOCKER_WEB_HOST=${MOODLE_DOCKER_WEB_HOST:-localhost}

# Webserver port
export MOODLE_DOCKER_WEB_PORT=${MOODLE_DOCKER_WEB_PORT:-8000}
if [[ $MOODLE_DOCKER_WEB_PORT == *":"* || $MOODLE_DOCKER_WEB_PORT -gt 0 ]]
then
    # If no bind ip has been configured (bind_ip:port), default to 127.0.0.1
    if [[ $MOODLE_DOCKER_WEB_PORT != *":"* ]]
    then
        MOODLE_DOCKER_WEB_PORT=127.0.0.1:$MOODLE_DOCKER_WEB_PORT
    fi
    dockercompose_cmd+=("-f" "${basedir}/webserver.port.yml")
fi


# Mac OS Compatbility
if [[ "$(uname)" == "Darwin" ]]; then
    # Support https://docs.docker.com/docker-for-mac/osxfs-caching/
    dockercompose_cmd+=("-f" "${basedir}/volumes-cached.yml")
fi

"${dockercompose_cmd[@]}" "$@"
