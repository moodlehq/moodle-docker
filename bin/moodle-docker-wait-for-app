#!/usr/bin/env bash
set -e

# If moodle-docker.env file found then use it as configuration values to match moodle-docker-compose script.
filename="moodle-docker.env"
if [ -f $filename ]; then
    export $(grep -v '^#' moodle-docker.env | xargs)
    if [ -z "$MOODLE_DOCKER_WWWROOT" ];
    then
      export MOODLE_DOCKER_WWWROOT="$( pwd )";
    fi
fi

basedir="$( cd "$( dirname "${BASH_SOURCE[0]}" )/../" && pwd )"

if [[ ! -z "$MOODLE_DOCKER_BROWSER" ]] && [[ "$MOODLE_DOCKER_BROWSER" == "chrome" ]] && ([[ ! -z "$MOODLE_DOCKER_APP_PATH" ]] || [[ ! -z "$MOODLE_DOCKER_APP_VERSION" ]] || [[ ! -z "$MOODLE_APP_VERSION" ]]);
then
    until $basedir/bin/moodle-docker-compose logs moodleapp | grep -q -E 'dev server running: |Angular Live Development Server is listening|Configuration complete; ready for start up';
    do
        echo 'Waiting for Moodle app to come up...'
        sleep 15
    done
fi
